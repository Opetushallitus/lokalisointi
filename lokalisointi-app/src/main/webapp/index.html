<!doctype html>
<html lang="fi">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Lokalisointi">
        <meta name="author" content="Opetushallitus">
        <title>Lokalisointi</title>

        <script src="lib/jquery-1.10.2.min.js"></script>
        <script src="lib/jquery-ui.min.js"></script>

        <!--
          Environment configuration file(s): ext/* - development only - see actual values from service filters.
        -->
        <script src="ext/js/env-configuration.js"></script>

        <!--
        Application configuration file(s):
        -->
        <script src="js/app-configuration.js"></script>
        <!--
         Developer configuration file(s):
        -->
        <script src="dev/dev-configuration.js"></script>

        <!--
        Angular, see version.txt for version.
        -->
        <script src="lib/angular/angular.js"></script>
        <script src="lib/angular/angular-resource.js"></script>
        <script src="lib/angular/angular-route.js"></script>
        <script src="lib/angular/angular-sanitize.js"></script>
        <script src="lib/angular/angular-animate.js"></script>

        <script src="lib/underscore/underscore.js"></script>
        <script src="lib/tinymce/tinymce.min.js"></script>
        <script src="lib/ui-angular-tinymce.js"></script>

        <script src="js/shared/loading.js"></script>

        <script src="js/filters.js"></script>
        <script src="js/directives.js"></script>
        <script src="js/services.js"></script>
        <script src="js/controllers.js"></script>
        <script src="js/app.js"></script>

        <script src="lib/ui-bootstrap-tpls-0.6.0.js"></script>

        <link href="lib/bootstrap-combined.min.css" rel="stylesheet">
        <link href="css/virkailija.css" rel="stylesheet"/>
        <link href="css/app.css" rel="stylesheet"/>

        <script type="text/javascript" src="/virkailija-raamit/apply-raamit.js"></script>
    </head>

    <body data-ng-controller="AppRoutingCtrl">

        STUFF HERE :)

        <div data-ng-controller="LoadingCtrl"
             data-ng-show="loading"
             id="ajax-loader"
             class="{{ isModal() ? 'max' : 'min'}}">
            <div>
                <img alt="Ladataan..." src="img/ajax-loader-big.gif" />
                <span>Ladataan...</span>
            </div>
        </div>

        <script>
                var init_counter = 0;
                var initFunction = function(id, xhr, status) {
                    init_counter--;

                    console.log("Got ready signal from: " + id);
                    console.log("  status = ", status);
                    console.log("  xhr = ", xhr);

                    if (init_counter > 0) {
                        console.log("Got ready signal from: '" + id + "' -- still waiting for " + init_counter + " requests.");
                    } else {
                        console.log("OK! That was the last request, init the app!");

                        angular.element(document).ready(function() {
                            angular.module('myApp', ['app']);
                            angular.bootstrap(document, ['myApp']);
                        });
                    }
                };


                //
                // Get current users authorisation info (/cas/myroles)
                //
                console.log("** Loading authentication info; from: ", window.CONFIG.env.casUrl);
                init_counter++;
                jQuery.ajax(window.CONFIG.env.casUrl, {
                    dataType: "json",
                    success: function(xhr, status) {
                        window.CONFIG.env["cas.myroles"] = xhr;
                        initFunction("AUTHENTICATION", xhr, status);
                    },
                    error: function(xhr, status) {
                        window.CONFIG.env["cas.myroles"] = [];
                        initFunction("AUTHENTICATION FAILED", xhr, status);
                    }
                });

                //
                // Preloadt application localisation
                //
                var localisationUrl = window.CONFIG.env.lokalisointiRestUrl;
                console.log("** Loading localisation info; from: ", localisationUrl);
                init_counter++;
                jQuery.ajax(localisationUrl, {
                    dataType: "json",
                    complete: function(xhr, status) {
                        window.CONFIG.env["localisations"] = xhr.responseJSON;
                        initFunction("localisations", xhr, status);
                    },
                    error: function(xhr, status) {
                        window.CONFIG.env["localisations"] = [];
                        initFunction("localisations FAILED", xhr, status);
                    }
                });
        </script>

    </body>
</html>
